{% extends "_base.html" %}
{% set title = "Meal" %}

{% block content %}
  <div class="pt-6 flex items-center justify-between">
    <div class="font-semibold text-lg">Log Meal</div>
    <a href="/dashboard" class="text-slate-400 text-sm">Back</a>
  </div>

  <div class="mt-4 bg-card border border-border rounded-3xl p-5">
    <div class="text-slate-300 text-sm">Upload a photo for quick estimate, or log manually.</div>

    <div class="mt-4">
      <input id="img" type="file" accept="image/*" class="w-full text-sm" />
      <button id="btn" class="mt-3 w-full py-3 rounded-2xl bg-white text-bg font-semibold">Analyze photo</button>
    </div>

    <div id="out" class="mt-4"></div>

    <div class="mt-6 border-t border-border pt-5">
      <div class="font-semibold">Manual entry</div>
      <form action="/api/log-food" method="post" class="mt-3 grid grid-cols-2 gap-3">
        <input name="product_name" placeholder="Meal name" class="col-span-2 bg-card2 border border-border rounded-2xl px-4 py-3 outline-none" required>
        <input name="calories" type="number" step="1" placeholder="Calories" class="bg-card2 border border-border rounded-2xl px-4 py-3 outline-none" required>
        <input name="protein" type="number" step="0.1" placeholder="Protein (g)" class="bg-card2 border border-border rounded-2xl px-4 py-3 outline-none">
        <input name="carbs" type="number" step="0.1" placeholder="Carbs (g)" class="bg-card2 border border-border rounded-2xl px-4 py-3 outline-none">
        <input name="fat" type="number" step="0.1" placeholder="Fat (g)" class="bg-card2 border border-border rounded-2xl px-4 py-3 outline-none">
        <input type="hidden" name="source" value="manual">
        <button class="col-span-2 py-3 rounded-2xl bg-white text-bg font-semibold">Add to Diary</button>
      </form>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  document.getElementById('btn').onclick = async () => {
    const f = document.getElementById('img').files[0];
    if(!f) return;
    const fd = new FormData();
    fd.append('image', f);
    const res = await fetch('/api/meal/analyze', { method:'POST', body: fd });
    const data = await res.json();
    const m = data.macros || {};
    document.getElementById('out').innerHTML = `
      <div class="bg-card2 border border-border rounded-3xl p-4">
        <div class="font-semibold">Detected: ${data.label}</div>
        <div class="text-slate-400 text-sm mt-1">Calories: ${Math.round(m.calories||0)} • P ${Math.round(m.protein||0)} • C ${Math.round(m.carbs||0)} • F ${Math.round(m.fat||0)}</div>
        <form action="/api/log-food" method="post" class="mt-3 grid grid-cols-2 gap-3">
          <input type="hidden" name="source" value="photo">
          <input name="product_name" value="${data.label}" class="col-span-2 bg-card border border-border rounded-2xl px-4 py-3 outline-none" required>
          <input name="calories" value="${Math.round(m.calories||0)}" class="bg-card border border-border rounded-2xl px-4 py-3 outline-none" required>
          <input name="protein" value="${Math.round(m.protein||0)}" class="bg-card border border-border rounded-2xl px-4 py-3 outline-none">
          <input name="carbs" value="${Math.round(m.carbs||0)}" class="bg-card border border-border rounded-2xl px-4 py-3 outline-none">
          <input name="fat" value="${Math.round(m.fat||0)}" class="bg-card border border-border rounded-2xl px-4 py-3 outline-none">
          <button class="col-span-2 py-3 rounded-2xl bg-white text-bg font-semibold">Add to Diary</button>
        </form>
        <div class="text-xs text-slate-500 mt-2">${data.note || ''}</div>
      </div>`;
  };
</script>
{% endblock %}
