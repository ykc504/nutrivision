{% extends "_base.html" %}
{% set title = "Dashboard" %}

{% macro donut(progress, size=112, stroke=10) -%}
  {# progress: 0-100 #}
  {% set r = (size/2) - (stroke/2) %}
  {% set c = 2*3.14159*r %}
  {% set dash = (c * (progress/100.0)) %}
  <svg width="{{size}}" height="{{size}}" viewBox="0 0 {{size}} {{size}}" class="block">
    <circle cx="{{size/2}}" cy="{{size/2}}" r="{{r}}" stroke="#1F2937" stroke-width="{{stroke}}" fill="none" />
    <circle cx="{{size/2}}" cy="{{size/2}}" r="{{r}}" stroke="#ffffff" stroke-width="{{stroke}}" fill="none"
            stroke-linecap="round" stroke-dasharray="{{dash}} {{c}}" transform="rotate(-90 {{size/2}} {{size/2}})" />
  </svg>
{%- endmacro %}

{% macro mini_donut(progress, ring_color="#F87171") -%}
  {% set size = 86 %}
  {% set stroke = 9 %}
  {% set r = (size/2) - (stroke/2) %}
  {% set c = 2*3.14159*r %}
  {% set dash = (c * (progress/100.0)) %}
  <svg width="{{size}}" height="{{size}}" viewBox="0 0 {{size}} {{size}}" class="block">
    <circle cx="{{size/2}}" cy="{{size/2}}" r="{{r}}" stroke="#1F2937" stroke-width="{{stroke}}" fill="none" />
    <circle cx="{{size/2}}" cy="{{size/2}}" r="{{r}}" stroke="{{ring_color}}" stroke-width="{{stroke}}" fill="none"
            stroke-linecap="round" stroke-dasharray="{{dash}} {{c}}" transform="rotate(-90 {{size/2}} {{size/2}})" />
  </svg>
{%- endmacro %}

{% block content %}
  <!-- Header -->
  <div class="pt-6 flex items-center justify-between">
    <div class="flex items-center gap-2">
      <div class="w-9 h-9 rounded-2xl bg-card border border-border flex items-center justify-center">üçé</div>
      <div class="font-semibold tracking-tight text-lg">NutriVision</div>
    </div>
    <div class="flex items-center gap-3">
      <a href="/" class="px-3 py-2 rounded-2xl bg-card border border-border text-xs text-slate-300">Landing</a>
      <div class="w-9 h-9 rounded-full bg-card border border-border"></div>
      <div class="px-3 py-1 rounded-full bg-card border border-border text-sm">üî• 15</div>
    </div>
  </div>

  <div class="mt-4 flex items-center gap-6 text-sm">
    <div class="text-slate-200">Today <span class="block w-1 h-1 bg-white rounded-full mx-auto mt-1"></span></div>
    <div class="text-slate-400">Yesterday</div>
  </div>

  <!-- Calories card (CalAI style) -->
  <div class="mt-5 bg-card border border-border rounded-3xl p-5 shadow-soft">
    <div class="flex items-center justify-between gap-4">
      <div>
        <div class="text-5xl font-semibold leading-none">{{ (user.calorie_target - consumed.calories) | round(0) | int }}</div>
        <div class="text-slate-400 mt-2">Calories left</div>
      </div>
      <div class="relative">
        {{ donut(progress.calories) }}
        <div class="absolute inset-0 flex items-center justify-center text-xl">üî•</div>
      </div>
    </div>
  </div>

  <!-- Macro mini cards (CalAI style) -->
  <div class="mt-4 grid grid-cols-3 gap-3">
    <div class="bg-card border border-border rounded-3xl p-4">
      <div class="text-2xl font-semibold">{{ (user.protein_target - consumed.protein) | round(0) | int }}g</div>
      <div class="text-slate-400 text-sm mt-1">Protein {% if consumed.protein > user.protein_target %}over{% else %}left{% endif %}</div>
      <div class="mt-3 flex justify-center">
        {{ mini_donut(progress.protein, "#FB7185") }}
      </div>
    </div>
    <div class="bg-card border border-border rounded-3xl p-4">
      <div class="text-2xl font-semibold">{{ (user.carb_target - consumed.carbs) | round(0) | int }}g</div>
      <div class="text-slate-400 text-sm mt-1">Carbs left</div>
      <div class="mt-3 flex justify-center">
        {{ mini_donut(progress.carbs, "#FDBA74") }}
      </div>
    </div>
    <div class="bg-card border border-border rounded-3xl p-4">
      <div class="text-2xl font-semibold">{{ (user.fat_target - consumed.fat) | round(0) | int }}g</div>
      <div class="text-slate-400 text-sm mt-1">Fats left</div>
      <div class="mt-3 flex justify-center">
        {{ mini_donut(progress.fat, "#60A5FA") }}
      </div>
    </div>
  </div>

  <!-- Risk Index + Actions -->
  <div class="mt-4 grid grid-cols-2 gap-3">
    <div class="bg-card border border-border rounded-3xl p-5">
      <div class="text-slate-400 text-sm">Health Risk Index</div>
      <div class="mt-2 flex items-end justify-between">
        <div>
          <div class="text-3xl font-semibold {{ risk.color }}">{{ risk.level }}</div>
          <div class="text-slate-400 text-sm mt-1">Score: {{ risk.score }}</div>
        </div>
        <div class="text-right text-xs text-slate-500">
          Sugar {{ risk.components.sugar }}g<br>
          Sodium {{ risk.components.sodium }}mg<br>
          NOVA-4 {{ risk.components.nova4_count }}<br>
          Additives {{ risk.components.additives_count }}
        </div>
      </div>
    </div>
    <div class="bg-card border border-border rounded-3xl p-5 flex flex-col justify-between">
      <div>
        <div class="font-semibold">Quick actions</div>
        <div class="mt-2 text-xs text-slate-400">
          {% if dashboard_mode == "diabetes" %}
            <span class="px-2 py-1 rounded-full bg-red-500/10 border border-red-500/20 text-red-300">Diabetes mode</span>
            <div class="mt-2">Focus: <b>Sugar load</b> ‚Ä¢ Prefer fiber + protein ‚Ä¢ Avoid sweet drinks.</div>
          {% elif dashboard_mode == "hypertension" %}
            <span class="px-2 py-1 rounded-full bg-yellow-500/10 border border-yellow-500/20 text-yellow-200">Hypertension mode</span>
            <div class="mt-2">Focus: <b>Sodium</b> ‚Ä¢ Choose low-salt options ‚Ä¢ Watch sauces & snacks.</div>
          {% elif dashboard_mode == "pcos" %}
            <span class="px-2 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-200">PCOS mode</span>
            <div class="mt-2">Focus: <b>Stable blood sugar</b> ‚Ä¢ Protein breakfast ‚Ä¢ Reduce refined carbs.</div>
          {% else %}
            <span class="px-2 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-emerald-300">General mode</span>
            <div class="mt-2">Focus: balance calories + macros ‚Ä¢ reduce ultra-processed foods.</div>
          {% endif %}
        </div>
        <div class="text-slate-400 text-sm mt-1">Scan products, meals, or a restaurant menu.</div>
      </div>
      <div class="mt-4 grid grid-cols-2 gap-2">
        <a href="/scan" class="py-3 rounded-2xl bg-white text-bg font-semibold text-center">Scan</a>
        <a href="/menu" class="py-3 rounded-2xl bg-card2 border border-border text-slate-200 font-semibold text-center">Menu</a>
      </div>
      <a href="/api/reports/weekly.pdf" class="mt-2 py-3 rounded-2xl bg-card2 border border-border text-slate-200 font-semibold text-center">Weekly PDF</a>
    </div>
  </div>

  <!-- Water (minimal) -->
  <div class="mt-4 bg-card border border-border rounded-3xl p-5">
    <div class="flex items-center justify-between">
      <div>
        <div class="font-semibold">Water</div>
        <div class="text-slate-400 text-sm mt-1">{{ consumed.water_ml }} ml today (goal: 2000 ml)</div>
      </div>
      <form action="/api/log-water" method="post" class="flex items-center gap-2">
        <input name="amount_ml" type="number" min="50" step="50" value="250"
               class="w-20 bg-card2 border border-border rounded-xl px-2 py-2 text-sm outline-none" />
        <button class="px-4 py-2 rounded-xl bg-white text-bg font-semibold">Add</button>
      </form>
    </div>
    <div class="mt-3 w-full h-2 rounded-full bg-card2">
      <div class="h-2 rounded-full bg-white" style="width: {{ progress.water }}%"></div>
    </div>
  </div>

  <!-- Recently uploaded -->
  <div class="mt-6">
    <div class="text-xl font-semibold">Recently uploaded</div>
    <div class="mt-3 space-y-3">
      {% for log in logs %}
        <div class="bg-card border border-border rounded-3xl p-4 flex items-center justify-between">
          <div>
            <div class="font-semibold truncate max-w-[240px]">{{ log.product_name }}</div>
            <div class="text-slate-400 text-sm mt-1">üî• {{ log.calories | round(0) | int }} kcal ‚Ä¢ P {{ log.protein | round(0) | int }} ‚Ä¢ C {{ log.carbs | round(0) | int }} ‚Ä¢ F {{ log.fat | round(0) | int }}</div>
          </div>
          <div class="text-slate-500 text-sm">{{ log.created_at[11:16] if log.created_at else "" }}</div>
        </div>
      {% else %}
        <div class="text-slate-400">No logs yet. Tap + to scan or log.</div>
      {% endfor %}
    </div>
  </div>

  <!-- AI Insight -->
  <div class="mt-5 bg-card border border-border rounded-3xl p-5">
    <div class="font-semibold">AI Insight</div>
    <div class="text-slate-300 text-sm mt-2">{{ insight }}</div>
    {% if who_warnings and who_warnings|length %}
      <div class="mt-3 text-sm text-slate-400">
        {% for w in who_warnings %}
          <div>‚Ä¢ {{ w }}</div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <!-- ProProfs Chat (optional): paste your embed snippet below. -->
  <!--
  <script>...</script>
  -->

{% endblock %}
